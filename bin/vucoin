#!/usr/bin/env node
var request = require('request');
var program = require('commander');
var vucoin  = require('../index');

program
  .version('0.0.8')
  .option('--add <keyFile>', 'File of the key to submit.')
  .option('--lookup <search>', 'Search string')
  .option('--peering', 'View peering informations')
  .option('-s, --signature <sigFile>', 'File of a signature to append.')
  .option('-h, --host <address>', 'DNS, IPv4 or IPv6 address of the node to contact.')
  .option('-p, --port <port>', 'Port of the node to contact.')
  .parse(process.argv);

program.host = program.host || "localhost";
program.port = program.port || "8081";

vucoin(program.host, program.port, function (err, node) {

  if(err){
    console.error(err);
    return;
  }

  // pks/add
  if(program.add && program.signature){
    node.pks.add(program.add, program.signature, proxy(function (res) {
      console.log("Posted key '" + res.fingerprint + "' of " + res.name + ' (' + res.comment + ')' + res.email);
    }));
    return;
  }

  // pks/lookup
  if(program.lookup != undefined){
    node.pks.lookup(program.lookup, proxy(function (res) {
      var keys = res.keys;
      console.log("Lookup '" + program.lookup + "' keys:");
      for (var i = 0; i < keys.length; i++) {
        console.log(keys[i].fingerprint);
      };
    }));
    return;
  }

  // ucg/peering
  if(program.peering){
    node.ucg.peering(proxy(function (res) {
      console.log("Currency: ", res.currency);
      console.log("Public key FPR: ", res.key);
      console.log("Remote host: ", res.remote.host);
      console.log("Remote port: ", res.remote.port);
      console.log("Peers number: ", res.peers.length);
      console.log("Peers list: ");
      res.peers.forEach(function (peer) {
        console.log(JSON.stringify(peer));
      });
    }));
    return;
  }

});

function proxy(callback){
  return function (err, res) {
    if(err){
      console.error(err);
      return;
    }
    else callback(res);
  }
}
